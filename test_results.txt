.s...................................................................... [ 23%]
............................x........................................... [ 46%]
.......................................................................s [ 69%]
ssssssss.sF............................................................. [ 92%]
........................API report: D:\code\ayan\appoinmentbackend\@results\20251110_182920\api_test_report.txt
API results JSON: D:\code\ayan\appoinmentbackend\@results\20251110_182920\api_test_results.json
API responses directory: D:\code\ayan\appoinmentbackend\@results\20251110_182920\responses
                                                                         [100%]
================================== FAILURES ===================================
_ TestErrorScenarios.test_invalid_methods[POST-/api/v1/contacts/-data0-expected_statuses0] _

self = <app.tests.integration.test_api_endpoints.TestErrorScenarios object at 0x00000204A7BE4C80>
api_request = functools.partial(<function api_request_factory.<locals>._request at 0x00000204A7CC5940>, request_context=<SubRequest 'api_request' for <Function test_invalid_methods[POST-/api/v1/contacts/-data0-expected_statuses0]>>)
method = 'POST', endpoint = '/api/v1/contacts/', data = {'test': 'data'}
expected_statuses = [403, 405]

    @pytest.mark.parametrize(
        "method,endpoint,data,expected_statuses",
        [
            ("POST", api_v1_path("/contacts/"), {"test": "data"}, [403, 405]),
            ("PUT", api_v1_path("/contacts/1/"), {"test": "data"}, [403, 405]),
            ("DELETE", api_v1_path("/contacts/1/"), None, [403, 405]),
        ],
    )
    def test_invalid_methods(
        self,
        api_request,
        method: str,
        endpoint: str,
        data: Optional[Mapping[str, Any]],
        expected_statuses: Iterable[int],
    ):
>       api_request(
            method,
            endpoint,
            json_body=data if isinstance(data, Mapping) else None,
            expected_statuses=expected_statuses,
        )

app\tests\integration\test_api_endpoints.py:976: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

method = 'POST', endpoint = '/api/v1/contacts/'

    def _request(
        method: str,
        endpoint: str,
        *,
        params: Optional[Mapping[str, Any]] = None,
        json_body: Optional[Mapping[str, Any]] = None,
        data: Optional[Mapping[str, Any]] = None,
        files: Optional[Mapping[str, Any]] = None,
        headers: Optional[Mapping[str, Any]] = None,
        expected_status: Optional[int] = 200,
        expected_statuses: Optional[Iterable[int]] = None,
        allow_timeout: bool = False,
        request_context: Optional[pytest.FixtureRequest] = None,
    ) -> requests.Response:
        if endpoint.startswith(("http://", "https://")):
            url = endpoint
        else:
            base = api_base_url.rstrip("/")
            suffix = endpoint if endpoint.startswith("/") else f"/{endpoint}"
            url = f"{base}{suffix}"
        request_headers = {"X-Request-Id": f"pytest-{int(time.time() * 1000)}"}
        if headers:
            request_headers.update(headers)
    
        start_time = time.perf_counter()
    
        try:
            response = api_session.request(
                method=method,
                url=url,
                params=params,
                json=json_body if files is None else None,
                data=data,
                files=files,
                headers=request_headers,
                timeout=api_timeout,
            )
            elapsed = time.perf_counter() - start_time
        except requests.exceptions.Timeout as exc:
            elapsed = time.perf_counter() - start_time
            api_test_recorder.record(
                test_name=(
                    request_context.node.nodeid
                    if request_context is not None
                    else f"{method} {endpoint}"
                ),
                method=method,
                endpoint=endpoint,
                url=url,
                status_code=None,
                expected_status=expected_status,
                expected_statuses=expected_statuses,
                success=allow_timeout,
                response_time=elapsed,
                params=params,
                error=f"Timeout: {exc}",
                request_id=request_headers.get("X-Request-Id"),
            )
            if allow_timeout:
                pytest.xfail(f"Expected timeout for {method} {endpoint}")
            pytest.fail(f"{method} {url} timed out after {elapsed:.2f}s")
        except requests.exceptions.RequestException as exc:  # pragma: no cover - defensive
            elapsed = time.perf_counter() - start_time
            api_test_recorder.record(
                test_name=(
                    request_context.node.nodeid
                    if request_context is not None
                    else f"{method} {endpoint}"
                ),
                method=method,
                endpoint=endpoint,
                url=url,
                status_code=None,
                expected_status=expected_status,
                expected_statuses=expected_statuses,
                success=False,
                response_time=elapsed,
                params=params,
                error=str(exc),
                request_id=request_headers.get("X-Request-Id"),
            )
            pytest.fail(f"{method} {url} request error: {exc}")
    
        response_body = response.text or ""
        response_is_json = False
        content_preview = response_body[:500] if response_body else ""
    
        content_type = response.headers.get("content-type", "").lower()
        if "application/json" in content_type:
            try:
                json.loads(response_body)
            except ValueError:
                response_is_json = False
            else:
                response_is_json = True
    
        response_preview = content_preview
        expected_ok = True
        expectation_desc = "any status"
    
        if expected_statuses:
            expected_set = set(expected_statuses)
            expected_ok = response.status_code in expected_set
            expectation_desc = f"one of {sorted(expected_set)}"
        elif expected_status is not None:
            expected_ok = response.status_code == expected_status
            expectation_desc = str(expected_status)
    
        api_test_recorder.record(
            test_name=(
                request_context.node.nodeid
                if request_context is not None
                else f"{method} {endpoint}"
            ),
            method=method,
            endpoint=endpoint,
            url=url,
            status_code=response.status_code,
            expected_status=expected_status,
            expected_statuses=expected_statuses,
            success=expected_ok,
            response_time=elapsed,
            params=params,
            request_id=request_headers.get("X-Request-Id"),
            response_preview=response_preview,
            response_body=response_body,
            response_is_json=response_is_json,
        )
    
        if not expected_ok:
>           pytest.fail(
                f"{method} {url} returned {response.status_code}, expected {expectation_desc}"
            )
E           Failed: POST http://localhost:8000/api/v1/contacts/ returned 201, expected one of [403, 405]

app\tests\integration\test_api_endpoints.py:413: Failed
=========================== short test summary info ===========================
SKIPPED [1] app\tests\integration\test_api_endpoints.py:489: Versioned health endpoint not available
SKIPPED [1] app\tests\integration\test_api_endpoints.py:818: Admin credentials required for CSV upload tests
SKIPPED [1] app\tests\integration\test_api_endpoints.py:836: Admin credentials required for CSV upload tests
SKIPPED [1] app\tests\integration\test_api_endpoints.py:853: Admin credentials required for CSV upload tests
SKIPPED [1] app\tests\integration\test_api_endpoints.py:866: Admin credentials required for CSV upload tests
SKIPPED [1] app\tests\integration\test_api_endpoints.py:881: Admin credentials required for CSV upload tests
SKIPPED [1] app\tests\integration\test_api_endpoints.py:899: Admin credentials required to create import jobs
SKIPPED [1] app\tests\integration\test_api_endpoints.py:908: Admin credentials required for import detail tests
SKIPPED [1] app\tests\integration\test_api_endpoints.py:918: Admin credentials required to create import jobs
SKIPPED [1] app\tests\integration\test_api_endpoints.py:928: Admin credentials required for import error download tests
SKIPPED [1] app\tests\integration\test_api_endpoints.py:950: Admin credentials required for authenticated admin tests
XFAIL app/tests/integration/test_api_endpoints.py::TestContactsList::test_special_character_search - Expected timeout for GET /api/v1/contacts/
FAILED app/tests/integration/test_api_endpoints.py::TestErrorScenarios::test_invalid_methods[POST-/api/v1/contacts/-data0-expected_statuses0]
1 failed, 299 passed, 11 skipped, 1 xfailed in 943.21s (0:15:43)
