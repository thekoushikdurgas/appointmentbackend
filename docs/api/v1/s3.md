# S3 File Operations API Documentation

Complete API documentation for S3 file operations endpoints, including listing CSV files, downloading CSV files, and reading paginated CSV data from S3 buckets.

**Related Documentation:**

- [Export API](./export.md) - For exporting contacts and companies to CSV
- [Large File Upload API](./upload.md) - For uploading large files (5GB+) to S3 using multipart uploads

## Table of Contents

- [Base URL](#base-url)
- [Authentication](#authentication)
- [S3 File Operations Endpoints](#s3-file-operations-endpoints)
  - [GET /api/v3/s3/files](#get-apiv3s3files---list-all-csv-files)
  - [GET /api/v3/s3/files/{file_id}](#get-apiv3s3filesfile_id---get-csv-file-or-paginated-data)
- [Response Schemas](#response-schemas)
- [Use Cases](#use-cases)
- [Error Handling](#error-handling)

---

## Base URL

For production, use:

```txt
http://54.87.173.234:8000
```

**API Version:** All S3 file endpoints are under `/api/v3/s3/files`

## Authentication

All S3 file endpoints require JWT authentication via the `Authorization` header:

```txt
Authorization: Bearer <access_token>
```

Tokens are obtained through the login or register endpoints.

## Role-Based Access Control

All S3 file endpoints are accessible to all authenticated users:

- **Free Users (`FreeUser`)**: ✅ Full access to S3 file operations
- **Pro Users (`ProUser`)**: ✅ Full access to S3 file operations
- **Admin (`Admin`)**: ✅ Full access to S3 file operations
- **Super Admin (`SuperAdmin`)**: ✅ Full access to S3 file operations

**Note:** All authenticated users can list, read, and download CSV files from the S3 bucket.

---

## S3 File Operations Endpoints

### GET /api/v3/s3/files - List All CSV Files

List all CSV files in the S3 bucket with their metadata.

**Headers:**

- `Authorization: Bearer <access_token>` (required)
- `Accept: application/json`

**Query Parameters:**

- `prefix` (string, optional): Optional prefix to filter files by path

**Example Request:**

```bash
GET /api/v3/s3/files?prefix=data/
Authorization: Bearer <access_token>
Accept: application/json
```

**Response:**

**Success (200 OK):**

```json
{
  "files": [
    {
      "key": "data/contacts_2024.csv",
      "filename": "contacts_2024.csv",
      "size": 1048576,
      "last_modified": "2024-01-15T10:30:00Z",
      "content_type": "text/csv"
    },
    {
      "key": "data/companies_2024.csv",
      "filename": "companies_2024.csv",
      "size": 2097152,
      "last_modified": "2024-01-16T14:20:00Z",
      "content_type": "text/csv"
    }
  ],
  "total": 2
}
```

**Response Codes:**

- `200 OK`: Files listed successfully
- `401 Unauthorized`: Authentication required
- `500 Internal Server Error`: Failed to list files

**Notes:**

- Only CSV files (ending with `.csv`) are returned
- Files are returned in the order they appear in S3
- The `prefix` parameter can be used to filter files in specific directories
- `file_id` in other endpoints refers to the full S3 object key (e.g., `data/contacts_2024.csv`)

---

### GET /api/v3/s3/files/{file_id} - Get CSV File or Paginated Data

Get a CSV file from S3 bucket. This endpoint has two modes of operation:

1. **Download Mode**: If `limit` and `offset` are NOT provided, returns the full CSV file for download
2. **Pagination Mode**: If `limit` and `offset` are provided, returns paginated CSV data as JSON

**Headers:**

- `Authorization: Bearer <access_token>` (required)
- `Accept: application/json` (for pagination mode) or `text/csv` (for download mode)

**Path Parameters:**

- `file_id` (string, required): S3 object key (full path) of the CSV file (e.g., `data/contacts_2024.csv`)

**Query Parameters:**

- `limit` (integer, optional, min: 1, max: 1000): Maximum number of rows to return (for pagination mode)
- `offset` (integer, optional, min: 0): Number of rows to skip (for pagination mode)

**Example Request - Download Full File:**

```bash
GET /api/v3/s3/files/data/contacts_2024.csv
Authorization: Bearer <access_token>
```

**Response (Download Mode - 200 OK):**

Returns the full CSV file with `Content-Type: text/csv` and `Content-Disposition: attachment` headers.

**Example Request - Get Paginated Data:**

```bash
GET /api/v3/s3/files/data/contacts_2024.csv?limit=50&offset=0
Authorization: Bearer <access_token>
Accept: application/json
```

**Response (Pagination Mode - 200 OK):**

```json
{
  "file_key": "data/contacts_2024.csv",
  "rows": [
    {
      "data": {
        "first_name": "John",
        "last_name": "Doe",
        "email": "john.doe@example.com",
        "company": "Acme Corp"
      }
    },
    {
      "data": {
        "first_name": "Jane",
        "last_name": "Smith",
        "email": "jane.smith@example.com",
        "company": "Tech Inc"
      }
    }
  ],
  "limit": 50,
  "offset": 0,
  "total_rows": 1000
}
```

**Response Codes:**

- `200 OK`: CSV file or data retrieved successfully
- `404 Not Found`: CSV file not found
- `401 Unauthorized`: Authentication required
- `500 Internal Server Error`: Failed to get CSV file

**Notes:**

- **Download Mode**: When `limit` is not provided, the endpoint returns the full CSV file for download
- **Pagination Mode**: When `limit` is provided, the endpoint returns paginated JSON data
- Rows in pagination mode are returned as dictionaries with column names as keys
- The `file_id` must be the full S3 object key, not just the filename
- The `limit` parameter has a maximum of 1000 rows per request
- Use pagination by incrementing `offset` to read through large files

---

## Response Schemas

### S3FileInfo

Schema for a single file information:

```typescript
{
  key: string;              // S3 object key (full path)
  filename: string;         // Filename extracted from key
  size: number | null;      // File size in bytes
  last_modified: string | null;  // ISO 8601 timestamp
  content_type: string | null;   // Content type/MIME type
}
```

### S3FileListResponse

Schema for file list response:

```typescript
{
  files: S3FileInfo[];
  total: number;
}
```

### S3FileDataRow

Schema for a single CSV row:

```typescript
{
  data: { [key: string]: any };  // Row data as dictionary
}
```

### S3FileDataResponse

Schema for paginated CSV data response:

```typescript
{
  file_key: string;
  rows: S3FileDataRow[];
  limit: number;
  offset: number;
  total_rows: number | null;  // null for large files
}
```

---

## Use Cases

### 1. List All CSV Files

Get a list of all CSV files in the S3 bucket:

```bash
GET /api/v3/s3/files
```

### 2. Filter Files by Prefix

List CSV files in a specific directory:

```bash
GET /api/v3/s3/files?prefix=data/2024/
```

### 3. Download Full CSV File

Download the complete CSV file:

```bash
GET /api/v3/s3/files/data/contacts_2024.csv
```

### 4. Read First 100 Rows (Pagination Mode)

Read the first 100 rows of a CSV file as JSON:

```bash
GET /api/v3/s3/files/data/contacts_2024.csv?limit=100&offset=0
```

### 5. Paginate Through Large File

Read a large CSV file in chunks:

```bash
# First page
GET /api/v3/s3/files/data/contacts_2024.csv?limit=1000&offset=0

# Second page
GET /api/v3/s3/files/data/contacts_2024.csv?limit=1000&offset=1000

# Third page
GET /api/v3/s3/files/data/contacts_2024.csv?limit=1000&offset=2000
```

---

## Error Handling

### File Not Found

**Request:**

```bash
GET /api/v3/s3/files/nonexistent.csv
```

**Response (404 Not Found):**

```json
{
  "detail": "CSV file not found: nonexistent.csv"
}
```

**Note:** The error message format may include additional details from the underlying S3 service error.

### Unauthorized Access

**Request:**

```bash
GET /api/v3/s3/files
# Missing Authorization header
```

**Response (401 Unauthorized):**

```json
{
  "detail": "Not authenticated"
}
```

### Invalid Pagination Parameters

**Request:**

```bash
GET /api/v3/s3/files/data/contacts.csv?limit=2000&offset=-10
```

**Response (422 Unprocessable Entity):**

```json
{
  "detail": [
    {
      "loc": ["query", "limit"],
      "msg": "ensure this value is less than or equal to 1000",
      "type": "value_error.number.not_le"
    },
    {
      "loc": ["query", "offset"],
      "msg": "ensure this value is greater than or equal to 0",
      "type": "value_error.number.not_ge"
    }
  ]
}
```

### Server Error

**Response (500 Internal Server Error) - List Files:**

```json
{
  "detail": "Failed to list CSV files: <error message>"
}
```

**Response (500 Internal Server Error) - Get File:**

```json
{
  "detail": "Failed to get CSV file: <error message>"
}
```

---

## Notes

- All endpoints require JWT authentication
- The `file_id` parameter must be the full S3 object key, including any path prefixes
- CSV files are parsed using Python's `csv.DictReader`, so column names are case-sensitive
- For very large files, consider using pagination to avoid memory issues
- The `total_rows` field may be `null` for files larger than 10MB to avoid reading the entire file for counting
- File listing is limited to CSV files only (files ending with `.csv`)
